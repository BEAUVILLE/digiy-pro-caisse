<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#020617"/>
  <title>DIGIY POS PRO ‚Äî G√©n√©rateur de fiche (Cr√©er / Modifier)</title>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../guard.js?v=pos-pro-profile-v1"></script>

  <style>
    :root{
      --bg:#020617; --card:#0B1120; --line:rgba(148,163,184,.22);
      --ink:#F9FAFB; --muted:#CBD5E1;
      --gold:#facc15; --green:#22c55e; --orange:#f97316; --bad:#fb7185;
      --r:18px; --shadow:0 18px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(circle at top, rgba(250,204,21,.10), transparent 55%),
        radial-gradient(circle at 18% 10%, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(circle at top,#0b1120 0,#020617 50%,#000 100%);
      padding:16px;
    }
    #guard_status{
      position:fixed; top:14px; right:14px; z-index:9999;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.78); color:#fff;
      font-weight:950; font-size:13px;
      backdrop-filter: blur(10px);
    }
    .app{display:none;}
    html.access-ok .app{display:block;}

    .wrap{max-width:980px;margin:0 auto;padding:10px 0 44px;}
    .card{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(11,17,32,.55);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    h1{
      margin:0 0 6px;
      font-size:26px;
      font-weight:1000;
      background:linear-gradient(135deg,var(--gold),var(--green));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .sub{
      margin:0 0 12px;
      color:var(--muted);
      font-weight:850;
      line-height:1.5;
    }
    .hr{height:1px;background:rgba(255,255,255,.10);margin:14px 0;}
    label{display:block;font-size:12px;color:rgba(203,213,225,.95);font-weight:950;margin:10px 0 6px;}
    input, textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(203,213,225,0.20);
      background:rgba(2,6,23,.55);
      color:var(--ink);
      padding:12px 12px;
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    input:focus, textarea:focus, select:focus{
      border-color:rgba(250,204,21,.55);
      box-shadow:0 0 0 3px rgba(250,204,21,.12);
    }
    textarea{min-height:92px;resize:vertical;font-weight:800;line-height:1.45}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:760px){.row{grid-template-columns:1fr}}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn{
      flex:1; min-width:220px;
      border-radius:999px;
      padding:13px 14px;
      font-weight:1000;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn.primary{
      border:none;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      color:#020617;
      box-shadow:0 10px 24px rgba(250,204,21,0.25);
    }
    .btn.green{
      border:none;
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.70));
      color:#02150b;
    }
    .btn:hover{transform:translateY(-1px)}
    .note{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(203,213,225,0.14);
      background:rgba(2,6,23,.45);
      padding:12px;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      line-height:1.5;
    }
    .ok{color:#bbf7d0;font-weight:1000}
    .bad{color:#fecaca;font-weight:1000}
    .hint{margin-top:6px;font-size:12px;color:rgba(203,213,225,.70);font-weight:850}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  </style>
</head>

<body>
  <div id="guard_status">üîê V√©rification‚Ä¶</div>

  <div class="app">
    <div class="wrap">
      <div class="card">
        <h1>üí≥ G√©n√©rateur de fiche ‚Äî POS (Caisse Pro)</h1>
        <p class="sub">
          Tu cr√©es / modifies ta fiche publique.  
          <span class="ok">Publi√© = visible</span> sur la vitrine automatiquement.
        </p>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label>Nom du commerce (display_name)</label>
            <input id="display_name" placeholder="Ex: Boutique Ndiaye" />
          </div>
          <div>
            <label>Cat√©gorie (category)</label>
            <input id="category" placeholder="Ex: Alimentation, Boutique, Salon, Pharmacie‚Ä¶" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ville (city)</label>
            <input id="city" placeholder="Ex: Dakar / Saly / Thi√®s‚Ä¶" />
          </div>
          <div>
            <label>Adresse (address)</label>
            <input id="address" placeholder="Ex: Saly Niakh Niakhal, route principale‚Ä¶" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>WhatsApp (sans espaces)</label>
            <input id="whatsapp" placeholder="Ex: 22177..." />
          </div>
          <div>
            <label>Photo vitrine (photo_url)</label>
            <input id="photo_url" placeholder="URL image (https://...jpg/png)" />
          </div>
        </div>

        <label>Bio (courte)</label>
        <textarea id="bio" placeholder="Ex: D√©p√¥t Wave, alimentation, transfert, produits maison‚Ä¶"></textarea>

        <div class="row">
          <div>
            <label>Tags (JSON ou liste simple)</label>
            <input id="tags" placeholder='Ex: wave,orange-money,alimentation ou ["wave","alimentation"]' />
          </div>
          <div>
            <label>Priorit√© (0‚Äì100)</label>
            <input id="priority" type="number" min="0" max="100" value="1"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Badge (badge)</label>
            <input id="badge" placeholder="Ex: ‚úÖ Commerce √©quip√©" />
          </div>
          <div>
            <label>Hub badge (hub_badge)</label>
            <input id="hub_badge" placeholder="Ex: üí≥ POS / ‚úÖ CAISSE PRO" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Price label (price_label)</label>
            <input id="price_label" placeholder="Ex: 0% commission ‚Ä¢ paiement direct" />
          </div>
          <div>
            <label>Publier maintenant ?</label>
            <select id="is_published">
              <option value="true">Oui (visible)</option>
              <option value="false">Non (brouillon)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Slug (interne)</label>
            <input id="slug" placeholder="auto" />
            <div class="hint">Slug stable : si fiche existe, on garde l‚Äôancien. Tu peux le r√©g√©n√©rer.</div>
          </div>
          <div>
            <label>URL fiche (profile_url)</label>
            <input id="profile_url" placeholder="Optionnel: lien externe vers ta fiche d√©taill√©e" />
            <div class="hint">Si vide, la vitrine mettra un lien fallback.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="actions">
          <button class="btn primary" id="btnSave" type="button">üíæ Enregistrer</button>
          <button class="btn green" id="btnReSlug" type="button">üßæ R√©g√©n√©rer slug</button>
          <button class="btn" id="btnCopy" type="button">üìã Copier le lien fiche</button>
          <button class="btn" id="btnOpen" type="button">üëÅÔ∏è Ouvrir</button>
          <button class="btn" id="btnBack" type="button">‚Ü©Ô∏è Retour cockpit</button>
        </div>

        <div class="note" id="msg">Statut : ‚Äî</div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const MODULE = "caisse"; // ou "pos" si ton guard utilise "pos"
  const PAY_URL = "https://beauville.github.io/commencer-a-payer/?module=CAISSE&offre=CAISSE";

  const gs = document.getElementById("guard_status");
  const msg = document.getElementById("msg");
  const $ = (id)=>document.getElementById(id);

  let SESSION = null;
  let EXISTING = null;

  function setMsg(t, ok=true){
    msg.innerHTML = `Statut : <span class="${ok?'ok':'bad'}">${t}</span>`;
  }

  function slugify(str){
    return String(str||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/(^-|-$)/g,"")
      .trim() || ("pos-" + Math.random().toString(16).slice(2,8));
  }

  function parseTags(raw){
    const s = String(raw||"").trim();
    if(!s) return null;
    if(s.startsWith("[") && s.endsWith("]")){
      try{
        const a = JSON.parse(s);
        return Array.isArray(a) ? a.map(x=>String(x).trim()).filter(Boolean) : null;
      }catch(_){}
    }
    return s.split(",").map(x=>x.trim()).filter(Boolean);
  }

  function getSb(){
    return window.DIGIY_GUARD?.getSb?.() || null;
  }

  function computeLink(row){
    const u = String(row?.profile_url || "").trim();
    if(u) return u;
    const slug = String(row?.slug || "").trim();
    if(slug) return `./p/${encodeURIComponent(slug)}`; // adapte si tu as une route
    return "";
  }

  async function loadExisting(owner_id){
    const sb = getSb();
    if(!sb) return;

    const { data, error } = await sb
      .from("digiy_pos_public_profiles")
      .select("*")
      .eq("owner_id", owner_id)
      .maybeSingle();

    if(error){
      console.warn(error);
      return setMsg("Erreur chargement fiche (console).", false);
    }

    EXISTING = data || null;

    if(!data){
      $("slug").value = slugify($("display_name").value || "");
      setMsg("Aucune fiche existante ‚Äî cr√©e la tienne ‚úÖ", true);
      return;
    }

    $("display_name").value = data.display_name || "";
    $("category").value = data.category || "";
    $("city").value = data.city || "";
    $("address").value = data.address || "";
    $("whatsapp").value = data.whatsapp || "";
    $("photo_url").value = data.photo_url || "";
    $("bio").value = data.bio || "";
    $("profile_url").value = data.profile_url || "";
    $("badge").value = data.badge || "";
    $("hub_badge").value = data.hub_badge || "üí≥ POS";
    $("price_label").value = data.price_label || "0% commission ‚Ä¢ paiement direct";
    $("priority").value = Number(data.priority ?? 1);
    $("is_published").value = String(!!data.is_published);
    $("slug").value = data.slug || slugify(data.display_name || "");

    try{
      $("tags").value = Array.isArray(data.tags) ? JSON.stringify(data.tags) : "";
    }catch(_){}

    setMsg("Fiche existante charg√©e ‚úÖ", true);
  }

  function buildPayload(){
    const display_name = $("display_name").value.trim();
    const category = $("category").value.trim();
    const city = $("city").value.trim();
    const address = $("address").value.trim();
    const whatsapp = $("whatsapp").value.trim().replace(/\s+/g,"");
    const photo_url = $("photo_url").value.trim();
    const bio = $("bio").value.trim();
    const tags = parseTags($("tags").value);
    const profile_url = $("profile_url").value.trim();
    const badge = $("badge").value.trim();
    const hub_badge = $("hub_badge").value.trim();
    const price_label = $("price_label").value.trim();
    const priority = Math.max(0, Math.min(100, parseInt($("priority").value,10) || 1));
    const is_published = ($("is_published").value === "true");

    if(!display_name) throw new Error("Nom du commerce requis");
    if(!whatsapp) throw new Error("WhatsApp requis (22177...)");

    // slug stable
    let slug = $("slug").value.trim();
    if(EXISTING?.slug) slug = EXISTING.slug;
    if(!slug) slug = slugify(display_name);

    return {
      owner_id: SESSION.owner_id,
      slug,
      display_name,
      category: category || null,
      city: city || null,
      address: address || null,
      whatsapp,
      photo_url: photo_url || null,
      bio: bio || null,
      tags: tags || null,
      profile_url: profile_url || null,
      is_published,
      is_active: true,
      is_verified: true,
      priority,
      badge: badge || "‚úÖ Commerce √©quip√©",
      hub_badge: hub_badge || "üí≥ POS",
      price_label: price_label || "0% commission ‚Ä¢ paiement direct"
    };
  }

  async function saveProfile(){
    const sb = getSb();
    if(!sb) return setMsg("Supabase non dispo (guard)", false);
    if(!SESSION?.owner_id) return setMsg("Session invalide", false);

    try{
      const payload = buildPayload();
      setMsg("Enregistrement‚Ä¶", true);

      let res = await sb
        .from("digiy_pos_public_profiles")
        .upsert(payload, { onConflict: "owner_id" })
        .select("*")
        .maybeSingle();

      if(res?.error){
        const err = String(res.error.message || "").toLowerCase();
        if(err.includes("onconflict") || err.includes("constraint") || err.includes("duplicate")){
          res = await sb
            .from("digiy_pos_public_profiles")
            .upsert(payload, { onConflict: "slug" })
            .select("*")
            .maybeSingle();
        }
      }

      if(res?.error){
        console.error(res.error);
        return setMsg("Erreur: " + (res.error.message || res.error), false);
      }

      EXISTING = res.data || payload;
      const link = computeLink(EXISTING);
      setMsg(`OK ‚úÖ enregistr√© ‚Ä¢ publi√©=${payload.is_published ? "oui" : "non"}${link ? " ‚Ä¢ lien pr√™t" : ""}`, true);

    }catch(e){
      setMsg(e?.message || "Erreur", false);
    }
  }

  function reSlug(){
    const dn = $("display_name").value.trim();
    const newSlug = slugify(dn || "commerce");
    $("slug").value = newSlug;
    if(EXISTING) EXISTING.slug = newSlug;
    setMsg("Slug r√©g√©n√©r√© ‚úÖ (pense √† Enregistrer)", true);
  }

  async function copyLink(){
    const link = computeLink(EXISTING);
    if(!link) return setMsg("Pas de lien (enregistre d‚Äôabord).", false);
    try{
      await navigator.clipboard.writeText(link);
      setMsg("Lien copi√© ‚úÖ", true);
    }catch(_){
      setMsg("Copie impossible. Lien: " + link, true);
    }
  }

  function openLink(){
    const link = computeLink(EXISTING);
    if(!link) return setMsg("Pas de lien (enregistre d‚Äôabord).", false);
    window.open(link, "_blank", "noopener");
  }

  async function init(){
    if(!window.DIGIY_GUARD || typeof window.DIGIY_GUARD.boot !== "function"){
      if(gs) gs.textContent = "‚ùå guard.js non charg√©";
      return;
    }

    const guardRes = await window.DIGIY_GUARD.boot({
      module: MODULE,
      dashboard: "./index.html",
      login: "./pin.html",
      pay: PAY_URL,
      requireSlug: true,
      checkSubscription: true
    });

    if(!guardRes?.ok){
      if(gs) gs.textContent = "‚ùå Acc√®s refus√©";
      return;
    }

    SESSION = window.DIGIY_GUARD.getSession?.() || null;
    if(!SESSION?.owner_id){
      if(gs) gs.textContent = "‚ùå Session invalide";
      location.replace("./pin.html");
      return;
    }

    document.documentElement.classList.add("access-ok");
    if(gs){
      gs.textContent = "‚úÖ PRO OK";
      setTimeout(()=>gs.style.display="none", 700);
    }

    setMsg("Pr√™t ‚úÖ (chargement de ta fiche‚Ä¶)", true);
    await loadExisting(SESSION.owner_id);

    $("btnSave").addEventListener("click", saveProfile);
    $("btnReSlug").addEventListener("click", reSlug);
    $("btnCopy").addEventListener("click", copyLink);
    $("btnOpen").addEventListener("click", openLink);

    $("btnBack").addEventListener("click", () => {
      location.href = "./index.html";
    });
  }

  init();
})();
</script>
</body>
</html>
