<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DIGIY ‚Äî PORTE PIN</title>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ‚úÖ IMPORTANT: bump le v= pour casser le cache -->
  <script src="./guard.js?v=20260201-caisse-token30j"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.72);
      --gold:#facc15; --ok:#22c55e; --bad:#fb7185; --cyan:#22d3ee;
      --shadow:0 18px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:radial-gradient(circle at top, rgba(250,204,21,.10), transparent 55%),
                 linear-gradient(135deg,#04160f,#0a2b1f);
      color:var(--text); padding:18px;
    }
    .card{
      width:min(560px,92vw);
      background:linear-gradient(145deg,rgba(11,42,31,.96),rgba(6,35,25,.96));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .ico{
      width:46px;height:46px;border-radius:50%;
      display:grid;place-items:center;
      background:radial-gradient(circle at 30% 0,var(--gold),transparent 60%);
      color:#062015;font-weight:1000;
      border:1px solid rgba(250,204,21,.35);
    }
    .t{font-weight:1000;letter-spacing:.12em;font-size:12px}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{
      border:1px solid var(--line);
      background:rgba(250,204,21,.10);
      padding:7px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .sep{height:1px;background:var(--line);margin:14px 0}
    .mini{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.45}
    .mini b{color:var(--text)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input{
      width:100%; padding:14px 14px;
      border-radius:14px; border:1px solid var(--line);
      background:rgba(0,0,0,.22); color:var(--text);
      font-size:16px; font-weight:900; letter-spacing:.14em;
      outline:none;
    }
    input:focus{border-color:rgba(250,204,21,.6); box-shadow:0 0 0 3px rgba(250,204,21,.10)}
    .btn{
      width:100%; margin-top:12px; padding:14px 14px;
      border-radius:14px; border:none;
      background:linear-gradient(90deg,var(--ok),var(--gold));
      color:#062015; font-weight:1000; font-size:15px;
      cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid rgba(255,255,255,.16);
    }
    .btn.cyan{
      background:linear-gradient(135deg,var(--cyan),#60a5fa);
      color:#04160f;
      border:none;
    }
    .row{display:grid;gap:10px;margin-top:10px}
    @media(min-width:520px){ .row{grid-template-columns:1fr 1fr} .row .span2{grid-column:span 2} }
    .msg{margin-top:12px;font-size:12px;color:var(--muted);line-height:1.5}
    .ok{color:var(--ok); font-weight:900}
    .bad{color:var(--bad); font-weight:900}
    .hint{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(34,197,94,.25);
      background:rgba(34,197,94,.08);
      color:#bbf7d0;
      font-weight:850;
      display:none;
      white-space:pre-wrap;
    }
    .hint.show{display:block}
    a.link{color:#fde68a;text-decoration:none;font-weight:900}
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="brand">
        <div class="ico">ü¶Ö</div>
        <div>
          <div class="t" id="title">PORTE PIN</div>
          <div class="sub" id="subtitle">Chargement‚Ä¶</div>
        </div>
      </div>
      <div class="pill" id="modPill">‚Äî</div>
    </div>

    <div class="sep"></div>

    <div class="mini">
      SLUG : <b id="slugBox">‚Äî</b><br>
      MODE : <b id="modeBox">‚Äî</b>
    </div>

    <div id="pinBlock">
      <label for="pin">Entre ton PIN</label>
      <input id="pin" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8"/>
      <button class="btn" id="go" type="button">üöÄ ENTRER</button>
    </div>

    <div class="hint" id="hint"></div>
    <div class="msg" id="msg"></div>

    <div class="row">
      <button class="btn cyan" id="btnTrial" type="button">üéÅ Essai 15 jours</button>
      <button class="btn secondary" id="btnPay" type="button">üßæ Activer licence</button>
      <button class="btn secondary span2" id="btnBack" type="button">‚Üê Retour</button>
    </div>
  </div>

<script>
(async () => {
  // =========================
  // ‚úÖ √Ä R√âGLER PAR MODULE
  // =========================
  const MODULE_CODE = "caisse_pro";     // ex: "loc_pro" | "pro_driver" | "caisse_pro" | "qr_pro" | "resto_pro" | "pay"
  const NEXT_URL    = "index.html";     // ex: "planning.html" | "cockpit.html" | "index.html"
  const PAY_URL     = "https://beauville.github.io/commencer-a-payer/"; // page paiement/activation

  // =========================
  // UI
  // =========================
  const $ = (id)=>document.getElementById(id);
  const url = new URL(location.href);

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setMsg(html){ $("msg").innerHTML = html || ""; }
  function setHint(text){
    $("hint").textContent = text || "";
    $("hint").classList.toggle("show", !!text);
  }

  $("modPill").textContent = MODULE_CODE;
  $("title").textContent = "PORTE ‚Äî " + MODULE_CODE.toUpperCase();

  const slug = (url.searchParams.get("slug") || "").trim().toLowerCase();
  const trial = url.searchParams.get("trial"); // "1" = demo
  $("slugBox").textContent = slug || "‚Äî";

  // =========================
  // PAY : pas de PIN / pas de slug
  // =========================
  if(MODULE_CODE === "pay"){
    $("modeBox").textContent = "PAY (sans PIN)";
    $("subtitle").textContent = "Paiement & activation ‚Äî sans PIN";
    $("pinBlock").style.display = "none";
    setHint("Ce module ne suit pas le moule PIN/SLUG.\nOn te redirige vers l‚Äôentr√©e PAY.");
    setTimeout(()=>{ location.replace(NEXT_URL); }, 700);
    return;
  }

  // =========================
  // MODE DEMO (trial=1) : entr√©e directe
  // =========================
  if(trial === "1"){
    $("modeBox").textContent = "DEMO (trial=1)";
    $("subtitle").textContent = "Mode d√©mo ‚Äî entr√©e directe";
    $("pinBlock").style.display = "none";
    setMsg(`<span class="ok">‚úÖ Mode d√©mo activ√©.</span> Ouverture‚Ä¶`);
    setHint("D√©mo 15 jours : acc√®s imm√©diat.\nPour passer PRO : bouton ‚ÄúActiver licence‚Äù.");
    const next = new URL(NEXT_URL, location.href);
    next.searchParams.set("trial","1");
    if(slug) next.searchParams.set("slug", slug);
    setTimeout(()=> location.replace(next.toString()), 450);
    return;
  }

  // =========================
  // MODE PRO : slug obligatoire
  // =========================
  $("modeBox").textContent = "PRO (PIN + slug)";
  $("subtitle").textContent = slug ? "Acc√®s s√©curis√© ‚Äî PIN requis" : "SLUG manquant";

  if(!slug){
    setMsg(`<span class="bad">‚ùå SLUG manquant.</span><br>Entre via ton Espace PRO / QR Factory (lien avec <b>?slug=...</b>).`);
    $("go").disabled = true;
  } else {
    setTimeout(()=>$("pin").focus(), 150);
  }

  // =========================
  // Boutons bas
  // =========================
  $("btnTrial").addEventListener("click", ()=>{
    const u = new URL(location.href);
    u.searchParams.set("trial","1");
    if(slug) u.searchParams.set("slug", slug);
    location.href = u.toString();
  });

  $("btnPay").addEventListener("click", ()=>{
    const p = new URL(PAY_URL, location.href);
    p.searchParams.set("module", MODULE_CODE);
    if(slug) p.searchParams.set("slug", slug);
    window.open(p.toString(), "_blank", "noopener");
  });

  $("btnBack").addEventListener("click", ()=>{
    if(history.length > 1) history.back();
    else location.href = "https://beauville.github.io/espace-pro/";
  });

  // =========================
  // Enter (PRO) ‚Äî ‚úÖ via DIGIY_GUARD (token 30j)
  // =========================
  async function enter(){
    const pin = ($("pin").value || "").trim();
    if(pin.length < 3){
      setMsg(`<span class="bad">‚ùå PIN invalide.</span>`);
      return;
    }

    $("go").disabled = true;
    setMsg(`V√©rification en cours‚Ä¶`);
    setHint("");

    if(!window.DIGIY_GUARD?.loginWithPin){
      $("go").disabled = false;
      setMsg(`<span class="bad">‚ùå Guard manquant.</span><br>V√©rifie que <b>guard.js</b> est bien charg√©.`);
      return;
    }

    const res = await window.DIGIY_GUARD.loginWithPin(slug, pin);

    if(!res?.ok){
      $("go").disabled = false;
      setMsg(`<span class="bad">‚ùå Acc√®s refus√©.</span><br>${escapeHtml(res?.error || "PIN incorrect")}`);
      return;
    }

    setMsg(`<span class="ok">‚úÖ Acc√®s valid√©.</span> Ouverture‚Ä¶`);

    setTimeout(()=>{
      const next = new URL(NEXT_URL, location.href);
      next.searchParams.set("slug", slug);
      location.href = next.toString();
    }, 450);
  }

  $("go").addEventListener("click", enter);
  $("pin").addEventListener("keydown", (e)=>{ if(e.key === "Enter") enter(); });

})();
</script>
</body>
</html>

