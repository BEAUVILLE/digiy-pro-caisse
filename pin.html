<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#061b14"/>
  <title>DIGIY PRO ‚Äî PIN ROYAL</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.72);
      --gold:#facc15; --ok:#22c55e; --bad:#fb7185; --warn:#f59e0b;
      --shadow:0 18px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:radial-gradient(circle at top, rgba(250,204,21,.10), transparent 55%),
                 linear-gradient(135deg,#04160f,#0a2b1f);
      color:var(--text); padding:18px;
    }
    .card{
      width:min(580px,92vw);
      background:linear-gradient(145deg,rgba(11,42,31,.96),rgba(6,35,25,.96));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:20px;
    }
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .ico{
      width:46px;height:46px;border-radius:50%;
      display:grid;place-items:center;
      background:radial-gradient(circle at 30% 0,var(--gold),transparent 60%);
      color:#062015;font-weight:1000;
      border:1px solid rgba(250,204,21,.35);
    }
    .t{font-weight:1000;letter-spacing:.12em;font-size:12px}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{
      border:1px solid var(--line);
      background:rgba(250,204,21,.10);
      padding:7px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .sep{height:1px;background:var(--line);margin:16px 0}

    .mini{font-size:12px;color:var(--muted);line-height:1.4}
    .mini b{color:var(--text)}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:220px}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input{
      width:100%; padding:14px;
      border-radius:14px; border:1px solid var(--line);
      background:rgba(0,0,0,.22); color:var(--text);
      font-size:15px; font-weight:800;
      outline:none;
    }
    #pin{letter-spacing:.18em;font-size:18px}

    button{
      width:100%; margin-top:12px; padding:14px;
      border-radius:14px; border:none;
      background:linear-gradient(90deg,var(--ok),var(--gold));
      color:#062015; font-weight:1000; font-size:15px;
      cursor:pointer;
    }
    button.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
    }
    button.danger{
      background:rgba(251,113,133,.10);
      border:1px solid rgba(251,113,133,.35);
      color:var(--text);
    }
    button:disabled{opacity:.6;cursor:not-allowed}

    .box{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.12);
      margin-top:14px;
    }

    .msg{margin-top:12px;font-size:12px;color:var(--muted);line-height:1.5}
    .ok{color:var(--ok);font-weight:900}
    .bad{color:var(--bad);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="brand">
        <div class="ico">üëë</div>
        <div>
          <div class="t">PIN ROYAL</div>
          <div class="sub" id="subtitle">Chargement‚Ä¶</div>
        </div>
      </div>
      <div class="pill" id="modulePill">‚Äî</div>
    </div>

    <div class="sep"></div>

    <div class="mini">
      MODULE : <b id="moduleBox">‚Äî</b><br>
      SLUG : <b id="slugBox">‚Äî</b>
    </div>

    <!-- MODE SAUVETAGE -->
    <div class="box" id="rescueBox" style="display:none;">
      <div class="mini"><b>üîé Retrouver mon acc√®s</b> ‚Äî si tu es arriv√© sans slug.</div>
      <div class="row">
        <div>
          <label>T√©l√©phone (digits)</label>
          <input id="rescuePhone" inputmode="numeric" placeholder="Ex: 221771234567" maxlength="15"/>
        </div>
        <div>
          <label>Module</label>
          <input id="rescueModule" placeholder="POS / RESTO / LOC / DRIVER..." maxlength="20"/>
        </div>
      </div>
      <button class="secondary" id="btnFindSlug">üß≠ Trouver mon acc√®s</button>
      <div class="msg" id="rescueMsg"></div>
    </div>

    <label>Entre ton PIN</label>
    <input id="pin" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>

    <button id="go">üöÄ ENTRER</button>
    <button class="danger" id="btnSupport">üõü Support WhatsApp</button>

    <div class="msg" id="msg"></div>
  </div>

<script>
(async () => {
  "use strict";

  const SUPPORT_WA = "+221771342889";

  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
  });

  const $ = id => document.getElementById(id);
  const msg = html => $("msg").innerHTML = html;
  const msgRescue = html => $("rescueMsg").innerHTML = html;

  const url = new URL(location.href);
  const rawModule = (url.searchParams.get("module") || "").toUpperCase();
  const ret = (url.searchParams.get("return") || "").trim();
  let currentSlug = (url.searchParams.get("slug") || "").toLowerCase();

  const MODULE_ALIAS = { CAISSE:"POS" };
  const TARGET_MODULE = MODULE_ALIAS[rawModule] || rawModule || "POS";

  $("moduleBox").textContent = TARGET_MODULE;
  $("modulePill").textContent = TARGET_MODULE;
  $("slugBox").textContent = currentSlug || "‚Äî";

  const cleanDigits = v => String(v||"").replace(/[^\d]/g,"").slice(0,15);
  const cleanModule = v => String(v||"").toUpperCase().replace(/[^A-Z_]/g,"");
  const cleanPin = v => String(v||"").replace(/[^\d]/g,"").slice(0,8);

  function wa(text){
    const num = SUPPORT_WA.replace(/\+/g,"");
    location.href = "https://wa.me/" + num + "?text=" + encodeURIComponent(text);
  }

  function goNext(){
    if(ret){
      const u = new URL(ret, location.origin);
      u.searchParams.set("slug", currentSlug);
      u.searchParams.set("module", TARGET_MODULE);
      u.searchParams.set("from","pin_royal");
      location.href = u.toString();
      return;
    }
    location.href = "/";
  }

  if(!currentSlug){
    $("rescueBox").style.display = "block";
    $("rescueModule").value = TARGET_MODULE;
    $("subtitle").textContent = "Mode sauvetage actif";
    msg(`<span class="warn">‚ö†Ô∏è Arriv√© sans slug.</span> Mets ton t√©l√©phone.`);
  } else {
    $("subtitle").textContent = "Acc√®s s√©curis√© ‚Äî PIN requis";
  }

  $("btnFindSlug").addEventListener("click", async ()=>{
    const phone = cleanDigits($("rescuePhone").value);
    const mod = cleanModule($("rescueModule").value || TARGET_MODULE);

    if(phone.length < 9){
      msgRescue(`<span class="bad">T√©l√©phone invalide.</span>`); return;
    }

    const { data } = await sb
      .from("digiy_subscriptions_public")
      .select("slug")
      .eq("phone", phone)
      .eq("module", mod)
      .limit(1);

    if(!data || !data[0]){
      msgRescue(`<span class="bad">Aucun acc√®s trouv√©.</span>`); return;
    }

    currentSlug = data[0].slug;
    $("slugBox").textContent = currentSlug;
    msgRescue(`<span class="ok">Acc√®s trouv√©.</span> Entre ton PIN.`);
  });

  async function enter(){
    const pin = cleanPin($("pin").value);
    if(!currentSlug){ msg(`<span class="bad">Slug manquant.</span>`); return; }
    if(pin.length < 3){ msg(`<span class="bad">PIN invalide.</span>`); return; }

    const { data } = await sb.rpc("digiy_verify_access", {
      p_slug: currentSlug,
      p_pin: pin,
      p_module: TARGET_MODULE
    });

    if(!data?.ok){
      msg(`<span class="bad">Acc√®s refus√©.</span>`); return;
    }

    localStorage.setItem("DIGIY_ACCESS", JSON.stringify({
      slug: currentSlug,
      module: TARGET_MODULE,
      ts: Date.now()
    }));

    msg(`<span class="ok">Acc√®s valid√©.</span>`);
    setTimeout(goNext,300);
  }

  $("go").addEventListener("click", enter);
  $("pin").addEventListener("keydown", e=>{ if(e.key==="Enter") enter(); });
  $("btnSupport").addEventListener("click", ()=>{
    wa("DIGIY PRO - Probl√®me PIN\nModule: "+TARGET_MODULE+"\nSlug: "+(currentSlug||"-"));
  });

})();
</script>
</body>
</html>
