<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#061b14" />
  <title>DIGIY POS ‚Äî Param√®tres Boutique</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard-pro.js?v=20260302"></script>
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--text:#f8fafc;--muted:#94a3b8;--gold:#fbbf24;--line:rgba(255,255,255,.08)}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;padding:16px}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;margin-bottom:12px}
    h1{margin:0 0 12px;font-size:18px}
    h3{margin:0 0 10px;font-size:14px}
    label{display:block;font-weight:900;font-size:12px;margin-top:10px;color:var(--muted)}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1225;color:#fff;outline:none;margin-top:6px;font-weight:900}
    textarea{min-height:80px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .btn{width:100%;padding:12px;border:0;border-radius:12px;font-weight:1000;cursor:pointer;background:linear-gradient(135deg,#fbbf24 0%,#d97706 100%);color:#000;margin-top:12px}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.14)}
    .muted{color:var(--muted);font-weight:800;font-size:12px;line-height:1.4}
    .ticket{background:#0b1225;border:1px dashed rgba(255,255,255,.18);border-radius:14px;padding:12px;font-family:ui-monospace,Menlo,monospace}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>‚öôÔ∏è Param√®tres Boutique ‚Äî DIGIY POS</h1>
    <button class="btn ghost" onclick="backToPos()">‚Üê Retour caisse</button>
  </div>

  <div class="card">
    <h3>üè¢ Identit√© Entreprise</h3>
    <div class="row">
      <div>
        <label>Nom boutique (affich√©)</label>
        <input id="store_name" placeholder="Ex: Boutique Astou" />
      </div>
      <div>
        <label>T√©l√©phone</label>
        <input id="phone" placeholder="22177..." />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Raison sociale (option)</label>
        <input id="legal_name" placeholder="Ex: Astou SARL" />
      </div>
      <div>
        <label>Email (option)</label>
        <input id="email" placeholder="contact@..." />
      </div>
    </div>

    <div class="row">
      <div>
        <label>NINEA (option)</label>
        <input id="ninea" placeholder="NINEA..." />
      </div>
      <div>
        <label>RCCM (option)</label>
        <input id="rccm" placeholder="RCCM..." />
      </div>
    </div>

    <label>Adresse (option)</label>
    <input id="address" placeholder="Saly, Mbour, Dakar..." />

    <div class="row">
      <div>
        <label>Devise</label>
        <select id="currency">
          <option value="XOF">XOF (FCFA)</option>
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>
      </div>
      <div>
        <label>Mode prix</label>
        <select id="pricing_mode">
          <option value="TTC">Prix saisis en TTC (recommand√© terrain)</option>
          <option value="HT">Prix saisis en HT</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>üßæ TVA</h3>
    <div class="row">
      <div>
        <label>Mode TVA</label>
        <select id="vat_mode" onchange="toggleVatRate()">
          <option value="none">Non assujetti (TVA = 0)</option>
          <option value="standard">TVA standard</option>
          <option value="custom">TVA personnalis√©e</option>
        </select>
      </div>
      <div>
        <label>Taux TVA (%)</label>
        <input id="vat_rate" type="number" placeholder="18" />
      </div>
    </div>
    <p class="muted">Astuce terrain : beaucoup de petites boutiques restent en TVA ‚Äúnone‚Äù. D√®s que tu passes PRO fiscal, tu actives.</p>
  </div>

  <div class="card">
    <h3>üßæ Ticket ‚Äî mention bas de re√ßu</h3>
    <label>Footer ticket</label>
    <textarea id="receipt_footer" placeholder="Merci et √† bient√¥t..."></textarea>
    <div style="margin-top:12px" class="ticket" id="ticketPreview">Chargement preview‚Ä¶</div>
  </div>

  <div class="card">
    <h3>‚úÖ Enregistrer</h3>
    <button class="btn" id="btnSave" onclick="save()">üíæ Sauvegarder les param√®tres</button>
    <p class="muted" id="status" style="margin-top:10px">‚Äî</p>
  </div>
</div>

<script>
let State = { owner_id:null, slug:"", phone:"", title:"", settings:null };
function getSB(){ return window.DIGIY_GUARD?.getSb?.() || null; }

function backToPos(){
  const url = new URL("./index.html", location.href);
  if(State.slug) url.searchParams.set("slug", State.slug);
  location.href = url.toString();
}
function toggleVatRate(){
  const mode = document.getElementById("vat_mode").value;
  const rate = document.getElementById("vat_rate");
  rate.disabled = (mode === "none");
  if(mode === "none") rate.value = "0";
  renderTicket();
}

function money(n,c){ c=c||"XOF"; const v=(Number(n||0)).toLocaleString("fr-FR"); return (c==="XOF")?`${v} F`:`${v} ${c}`; }

function renderTicket(){
  const store = document.getElementById("store_name").value || "MA BOUTIQUE";
  const mode  = document.getElementById("vat_mode").value;
  const rate  = Number(document.getElementById("vat_rate").value||0);
  const pmode = document.getElementById("pricing_mode").value;
  const cur   = document.getElementById("currency").value || "XOF";
  const foot  = document.getElementById("receipt_footer").value || "";

  const exampleTTC = 2500;
  let ht=exampleTTC, tva=0, ttc=exampleTTC;
  if(mode !== "none" && rate>0){
    if(pmode==="TTC"){
      ht = Math.round(exampleTTC / (1 + rate/100));
      tva = exampleTTC - ht;
      ttc = exampleTTC;
    } else {
      ht = exampleTTC;
      tva = Math.round(ht * rate/100);
      ttc = ht + tva;
    }
  }

  document.getElementById("ticketPreview").textContent =
`${store}
--------------------------------
ARTICLE EXEMPLE x1
${pmode==="TTC" ? "TOTAL TTC" : "TOTAL HT"} : ${money(pmode==="TTC"?ttc:ht,cur)}
TVA (${rate}%) : ${money(tva,cur)}
TOTAL TTC : ${money(ttc,cur)}
--------------------------------
${mode==="none" ? "TVA non applicable" : "TVA incluse"}
${foot}`;
}

async function load(){
  if(!window.DIGIY_GUARD?.boot) return;
  const res = await window.DIGIY_GUARD.boot();
  if(!res?.ok) return;

  const sess = window.DIGIY_GUARD.getSession?.() || null;
  State.owner_id = sess?.owner_id || null;
  State.slug = sess?.slug || "";
  State.phone = sess?.phone || "";
  State.title = sess?.title || "";

  if(!State.owner_id){ backToPos(); return; }

  const sb=getSB();
  const {data, error} = await sb.from("digiy_caisse_settings").select("*").eq("owner_id",State.owner_id).maybeSingle();
  if(error){ document.getElementById("status").textContent="‚ùå "+error.message; return; }

  const s = data || {};
  document.getElementById("store_name").value = s.store_name || State.title || "MA BOUTIQUE";
  document.getElementById("phone").value = s.phone || State.phone || "";
  document.getElementById("legal_name").value = s.legal_name || "";
  document.getElementById("email").value = s.email || "";
  document.getElementById("ninea").value = s.ninea || "";
  document.getElementById("rccm").value = s.rccm || "";
  document.getElementById("address").value = s.address || "";
  document.getElementById("currency").value = s.currency || "XOF";
  document.getElementById("pricing_mode").value = s.pricing_mode || "TTC";
  document.getElementById("vat_mode").value = s.vat_mode || "none";
  document.getElementById("vat_rate").value = String(s.vat_rate ?? 0);
  document.getElementById("receipt_footer").value = s.receipt_footer || "Merci et √† bient√¥t ‚Äî DIGIY ‚ôæÔ∏è";

  toggleVatRate();
  renderTicket();

  ["store_name","vat_rate","pricing_mode","receipt_footer","currency"].forEach(id=>{
    document.getElementById(id).addEventListener("input", renderTicket);
  });
}

async function save(){
  const sb=getSB(); if(!sb) return;
  const btn=document.getElementById("btnSave"); btn.disabled=true;
  try{
    const payload = {
      store_name: document.getElementById("store_name").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      legal_name: document.getElementById("legal_name").value.trim(),
      email: document.getElementById("email").value.trim(),
      ninea: document.getElementById("ninea").value.trim(),
      rccm: document.getElementById("rccm").value.trim(),
      address: document.getElementById("address").value.trim(),
      currency: document.getElementById("currency").value,
      pricing_mode: document.getElementById("pricing_mode").value,
      vat_mode: document.getElementById("vat_mode").value,
      vat_rate: Number(document.getElementById("vat_rate").value||0),
      receipt_footer: document.getElementById("receipt_footer").value.trim()
    };

    const {error} = await sb.from("digiy_caisse_settings").update(payload).eq("owner_id", State.owner_id);
    if(error) throw error;

    document.getElementById("status").textContent="‚úÖ Param√®tres enregistr√©s";
  }catch(e){
    document.getElementById("status").textContent="‚ùå "+(e?.message||e);
  }finally{
    btn.disabled=false;
  }
}

load();
</script>
</body>
</html>
