<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIY POS ELITE ‚Äî Royal Edition</title>
      <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Guard -->
    <script src="./guard.js"></script>    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --gold: #fbbf24; --gold-dark: #d97706;
            --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --muted: #94a3b8;
            --glass: rgba(255, 255, 255, 0.03);
            --gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --green: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; background-image: radial-gradient(circle at top right, #1e293b, #0f172a); }

        /* √âcran de verrouillage - Tunnel de vente */
        #lockScreen { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .lock-box { background: var(--card); padding: 40px; border-radius: 30px; border: 1px solid var(--gold); text-align: center; width: 90%; max-width: 450px; box-shadow: 0 0 50px rgba(251, 191, 36, 0.1); }
        
        .pay-link-btn { 
            display: block; width: 100%; padding: 18px; background: var(--green); color: white; 
            text-decoration: none; border-radius: 12px; font-weight: 800; margin-bottom: 20px;
            transition: 0.3s; border: none; font-size: 14px;
        }
        .pay-link-btn:hover { transform: scale(1.02); filter: brightness(1.1); }

        /* Interface Header */
        .header { padding: 20px 25px; background: var(--glass); border-bottom: 1px solid rgba(251, 191, 36, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .crown-icon { width: 45px; height: 45px; background: var(--gradient); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #000; font-size: 20px; }

        .nav-elite { display: flex; gap: 10px; padding: 15px 25px; overflow-x: auto; scrollbar-width: none; }
        .nav-link { padding: 12px 25px; background: var(--card); border-radius: 12px; color: var(--muted); cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-weight: 600; white-space: nowrap; }
        .nav-link.active { background: var(--gradient); color: #000; border-color: var(--gold); }

        .main-container { padding: 20px; display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1100px) { .main-container { grid-template-columns: 1fr; } }

        .products-listing { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .noble-card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; cursor: pointer; position: relative; }
        .noble-card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .noble-card i { font-size: 30px; color: var(--gold); margin-bottom: 12px; display: block; }

        .royal-cart { background: var(--card); border-radius: 25px; padding: 25px; border: 1px solid rgba(251, 191, 36, 0.1); height: fit-content; position: sticky; top: 20px; }
        .cart-scroll { max-height: 300px; overflow-y: auto; margin: 15px 0; }
        .cart-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }

        .pay-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .pay-btn { padding: 14px; border: none; border-radius: 12px; color: white; font-weight: 800; cursor: pointer; font-size: 10px; text-transform: uppercase; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-card { background: var(--card); padding: 25px; border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        input { width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; border-radius: 10px; color: white; margin-top: 8px; outline: none; }
        .gold-btn { width: 100%; padding: 16px; background: var(--gradient); border: none; border-radius: 12px; color: #000; font-weight: 800; cursor: pointer; margin-top: 15px; }
        
        .dash-link { background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; color: white !important; }
        .inventory-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-box">
        <i class="fas fa-gem" style="font-size: 50px; color: var(--gold); margin-bottom: 20px;"></i>
        <h2 style="margin-bottom: 10px;">ESSAI TERMIN√â</h2>
        <p style="color: var(--muted); margin-bottom: 25px; font-size: 14px;">
            Pour continuer √† utiliser vos outils de gestion et d√©bloquer les rapports comptables illimit√©s, passez √† la version Pro.
        </p>
        
        <a href="https://beauville.github.io/commencer-a-payer/" class="pay-link-btn">
            <i class="fas fa-shopping-cart"></i> COMMENCER √Ä PAYER
        </a>

        <div style="margin: 20px 0; color: var(--muted); font-size: 11px;">OU ENTREZ VOTRE CL√â PERSONNELLE</div>
        <input type="text" id="royalKey" placeholder="XXXX-XXXX-XXXX-XXXX">
        <button class="gold-btn" onclick="activate('royalKey')">ACTIVER</button>
    </div>
</div>

<div class="header">
    <div class="brand">
        <div class="crown-icon"><i class="fas fa-eagle"></i></div>
        <div>
            <h2 id="storeDisp">CHARGEMENT...</h2>
            <div id="trialBadge"></div>
        </div>
    </div>
    <div style="text-align: right;">
        <span style="color: var(--gold); font-weight: 900; font-size: 10px;">ROYAL EDITION</span>
    </div>
</div>

<div class="nav-elite">
    <div class="nav-link active" onclick="tab('pos', this)"><i class="fas fa-store"></i> CAISSE</div>
    <div class="nav-link" onclick="tab('history', this)"><i class="fas fa-history"></i> VENTES</div>
    <div class="nav-link" onclick="tab('admin', this)"><i class="fas fa-cog"></i> GESTION</div>
</div>

<div id="posPage" class="page active">
    <div class="main-container">
        <div id="productsGrid" class="products-listing"></div>
        <div class="royal-cart">
            <h3 style="font-size: 10px; color: var(--muted); text-transform:uppercase;">PANIER ROYAL</h3>
            <div id="cartListing" class="cart-scroll"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--gold); padding-top: 15px;">
                <b>TOTAL</b>
                <h2 id="totalPrice" style="color: var(--gold);">0 F</h2>
            </div>
            <div class="pay-grid">
                <button class="pay-btn" style="background: #10b981;" onclick="checkout('CASH')">Cash</button>
                <button class="pay-btn" style="background: #0ea5e9;" onclick="checkout('WAVE')">Wave</button>
                <button class="pay-btn" style="background: #f97316;" onclick="checkout('OM')">Orange</button>
                <button class="pay-btn" style="background: #ef4444;" onclick="checkout('CREDIT')">Dette</button>
                <button class="pay-btn" style="background: #64748b; grid-column: span 2;" onclick="db.cart=[];render()">VIDER LE PANIER</button>
            </div>
        </div>
    </div>
</div>

<div id="historyPage" class="page">
    <div class="main-container" style="display: block; max-width: 600px; margin: auto;">
        <div class="form-card" style="text-align:center;">
            <small>RECETTE DU JOUR</small>
            <h2 id="revDay" style="color:var(--green); font-size: 2.5rem;">0 F</h2>
        </div>
        <div id="historyListing"></div>
    </div>
</div>

<div id="adminPage" class="page">
    <div class="main-container" style="display: block; max-width: 600px; margin: auto;">
        <div class="form-card dash-link">
            <h3><i class="fas fa-chart-line"></i> DASHBOARD & COMPTABILIT√â</h3>
            <button class="gold-btn" onclick="window.location.href='dashboard.html'" style="background:white; color:#059669;">OUVRIR LES RAPPORTS</button>
        </div>
        <div class="form-card">
            <h3>‚öôÔ∏è PARAM√àTRES BOUTIQUE</h3>
            <p style="color:var(--muted); font-size:13px; margin-bottom:15px;">
                Configure tes infos l√©gales, TVA, logo et mentions pour les tickets
            </p>
            <button class="gold-btn" onclick="goSettings()">OUVRIR LES PARAM√àTRES</button>
        </div>        
        <div class="form-card">
            <h3>üì¶ NOUVEAU PRODUIT</h3>
            <input type="text" id="addName" placeholder="D√©signation">
            <input type="number" id="addPrice" placeholder="Prix">
            <input type="number" id="addStock" placeholder="Stock">
            <button class="gold-btn" onclick="addNew()">AJOUTER AU STOCK</button>
        </div>

        <div class="form-card">
            <h3>üóëÔ∏è GESTION DU STOCK</h3>
            <div id="inventoryManager"></div>
        </div>
    </div>
</div>
<script>
// =============================
// GUARD + SUPABASE INIT
// =============================
const TRIAL_LIMIT = 15;

let State = {
    owner_id: null,
    slug: null,
    phone: null,
    title: null,
    pro: false,
    storeName: "MA BOUTIQUE NOBLE",
    items: [],
    sales: [],
    cart: [],
    settings: null
};

function getSB() {
    return window.DIGIY_GUARD?.getSb?.() || null;
}

// =============================
// INIT + PROTECTION
// =============================
(async function init() {
    if (!window.DIGIY_GUARD || typeof window.DIGIY_GUARD.boot !== "function") {
        console.warn("Guard absent (guard.js non charg√©).");
        return;
    }

    // üîí Prot√®ge la page
    const guardRes = await window.DIGIY_GUARD.boot({
        login: "./pin.html"
    });

    if (!guardRes?.ok) return;

    const sess = window.DIGIY_GUARD.getSession?.() || null;
    State.owner_id = sess?.owner_id || null;
    State.phone = sess?.phone || "";
    State.slug = sess?.slug || "";
    State.title = sess?.title || "";

    if (!State.owner_id) {
        console.warn("owner_id introuvable, retour PIN.");
        window.location.replace("./pin.html");
        return;
    }

    console.log("‚úÖ Session OK, owner_id:", State.owner_id);

    // Charger les donn√©es
    await loadData();
    render();
})();

// =============================
// LOAD DATA FROM SUPABASE
// =============================
async function loadData() {
    const sb = getSB();
    if (!sb || !State.owner_id) return;

    try {
        // Charger settings
        const { data: settings } = await sb
            .from('digiy_caisse_settings')
            .select('*')
            .eq('owner_id', State.owner_id)
            .maybeSingle();

        if (settings) {
            State.settings = settings;
            State.storeName = settings.store_name || "MA BOUTIQUE NOBLE";
            State.pro = settings.is_pro || false;
        } else {
            // Cr√©er settings par d√©faut
            await sb.from('digiy_caisse_settings').insert({
                owner_id: State.owner_id,
                store_name: State.title || "MA BOUTIQUE NOBLE",
                phone: State.phone
            });
            State.storeName = State.title || "MA BOUTIQUE NOBLE";
        }

        // Charger produits
        const { data: products } = await sb
            .from('digiy_caisse_products')
            .select('*')
            .eq('owner_id', State.owner_id)
            .eq('is_active', true)
            .order('created_at', { ascending: false });

        State.items = products || [];

        // Charger ventes
        const { data: sales } = await sb
            .from('digiy_caisse_sales')
            .select('*')
            .eq('owner_id', State.owner_id)
            .order('created_at', { ascending: false })
            .limit(100);

        State.sales = sales || [];

    } catch (e) {
        console.error("Erreur chargement:", e);
    }
}

// =============================
// NAVIGATION
// =============================
function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.getElementById(id + 'Page').classList.add('active');
    btn.classList.add('active');
    render();
}

// =============================
// RENDER
// =============================
function render() {
    // Trial badge
    const diff = Date.now() - new Date(State.settings?.trial_start || Date.now()).getTime();
    const passed = Math.floor(diff / (1000 * 60 * 60 * 24));
    const left = Math.max(0, TRIAL_LIMIT - passed);

    if (!State.pro && left <= 0) {
        document.getElementById('lockScreen').style.display = 'flex';
    }

    document.getElementById('storeDisp').innerText = State.storeName;
    document.getElementById('trialBadge').innerHTML = State.pro ?
        '<span style="color:var(--gold); font-size:10px;">LICENCE ACTIVE</span>' :
        `<span style="background:var(--gold); color:#000; padding:2px 8px; border-radius:10px; font-size:9px; font-weight:bold;">TRIAL: ${left} JOURS</span>`;

    // Produits
    document.getElementById('productsGrid').innerHTML = State.items.map(p => `
        <div class="noble-card" onclick="addToCart('${p.id}')">
            <i class="fas fa-tag"></i>
            <span style="display:block; font-weight:700;">${p.name}</span>
            <span style="color:var(--gold); font-weight:800;">${p.price.toLocaleString()} F</span>
            <div style="font-size:9px; color:var(--muted); margin-top:8px;">STK: ${p.stock}</div>
        </div>
    `).join('');

    // Inventory
    document.getElementById('inventoryManager').innerHTML = State.items.map(p => `
        <div class="inventory-item">
            <span>${p.name}</span>
            <button onclick="removeItem('${p.id}')" style="background:none; border:none; color:#ef4444; cursor:pointer;"><i class="fas fa-trash"></i></button>
        </div>
    `).join('');

    // Panier
    document.getElementById('cartListing').innerHTML = State.cart.map(i => `
        <div class="cart-row"><span>${i.name} x${i.qty}</span><span>${(i.price * i.qty).toLocaleString()} F</span></div>
    `).join('');

    const total = State.cart.reduce((s, i) => s + (i.price * i.qty), 0);
    document.getElementById('totalPrice').innerText = total.toLocaleString() + " F";

    // Stats du jour
    const today = new Date().toLocaleDateString();
    const rev = State.sales
        .filter(s => new Date(s.created_at).toLocaleDateString() === today)
        .reduce((a, b) => a + b.total, 0);
    document.getElementById('revDay').innerText = rev.toLocaleString() + " F";
}

// =============================
// PANIER
// =============================
function addToCart(id) {
    const p = State.items.find(x => String(x.id) === String(id));
    if (!p) return;
    if (p.stock <= 0) return alert("Plus de stock !");

    const inCart = State.cart.find(x => String(x.id) === String(id));
    if (inCart) {
        inCart.qty++;
    } else {
        State.cart.push({ ...p, qty: 1 });
    }
    render();
}

// =============================
// CHECKOUT
// =============================
async function checkout(method) {
    if (!State.cart.length) return;

    const sb = getSB();
    if (!sb) return alert("Supabase non disponible");

    const total = State.cart.reduce((s, i) => s + (i.price * i.qty), 0);

    try {
        // Enregistrer la vente
        const { error: saleError } = await sb.from('digiy_caisse_sales').insert({
            owner_id: State.owner_id,
            total: total,
            payment_method: method,
            items: State.cart.map(i => ({
                id: i.id,
                name: i.name,
                price: i.price,
                qty: i.qty
            }))
        });

        if (saleError) throw saleError;

        // D√©cr√©menter le stock
        for (const item of State.cart) {
            const newStock = item.stock - item.qty;
            await sb.from('digiy_caisse_products')
                .update({ stock: newStock })
                .eq('id', item.id)
                .eq('owner_id', State.owner_id);
        }

        State.cart = [];
        await loadData();
        render();
        alert("‚úÖ Vente valid√©e !");

    } catch (e) {
        console.error(e);
        alert("‚ùå Erreur: " + (e?.message || e));
    }
}

// =============================
// AJOUTER PRODUIT
// =============================
async function addNew() {
    const sb = getSB();
    if (!sb) return alert("Supabase non disponible");

    const name = document.getElementById('addName').value.trim();
    const price = parseInt(document.getElementById('addPrice').value);
    const stock = parseInt(document.getElementById('addStock').value) || 0;

    if (!name || !price) return alert("Nom et prix requis");

    try {
        const { error } = await sb.from('digiy_caisse_products').insert({
            owner_id: State.owner_id,
            name: name,
            price: price,
            stock: stock
        });

        if (error) throw error;

        document.getElementById('addName').value = '';
        document.getElementById('addPrice').value = '';
        document.getElementById('addStock').value = '';

        await loadData();
        render();
        alert("‚úÖ Produit ajout√© !");

    } catch (e) {
        console.error(e);
        alert("‚ùå Erreur: " + (e?.message || e));
    }
}

// =============================
// SUPPRIMER PRODUIT
// =============================
async function removeItem(id) {
    if (!confirm("Supprimer l'article ?")) return;

    const sb = getSB();
    if (!sb) return;

    try {
        const { error } = await sb.from('digiy_caisse_products')
            .update({ is_active: false })
            .eq('id', id)
            .eq('owner_id', State.owner_id);

        if (error) throw error;

        await loadData();
        render();

    } catch (e) {
        console.error(e);
        alert("‚ùå Erreur: " + (e?.message || e));
    }
}

// =============================
// ACTIVATION PRO
// =============================
async function activate(inputId) {
    const key = document.getElementById(inputId).value;

    if (key === "DIGIY-PRO-2026") {
        const sb = getSB();
        if (!sb) return alert("Supabase non disponible");

        try {
            await sb.from('digiy_caisse_settings')
                .update({ is_pro: true, pro_key: key })
                .eq('owner_id', State.owner_id);

            location.reload();
        } catch (e) {
            alert("‚ùå Erreur: " + e.message);
        }
    } else {
        alert("Cl√© invalide !");
    }
}
    // =============================
// GO SETTINGS
// =============================
function goSettings() {
  const url = new URL('./settings.html', location.href);
  if (State.slug) url.searchParams.set('slug', State.slug);
  window.location.href = url.toString();
}</script>
</body>
</html>
